<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Audio Stream Player</title>
</head>
<body>
  <h3>Tap to Start Listening</h3>
  <button onclick="start()">Start Listening</button>
  <div id="status">Idle</div>

  <!-- Real audio element for background support -->
  <audio id="keepAlive" autoplay loop>
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////8AAAAACAAADSAAAAEsAAABJbnRlcnBsYXllciBSZWFkAA==" type="audio/mp3">
  </audio>

  <script>
    let ws;
    let audioContext;
    let audioQueue = [];
    let isPlaying = false;
    const MIN_BUFFER = 3;

    function start() {
      // Play real audio for lock screen support
      const keepAlive = document.getElementById("keepAlive");
      keepAlive.volume = 0.01; // inaudible but not muted
      keepAlive.play();

      // Web audio setup
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      ws = new WebSocket("wss://audio-stream-backend-688e.onrender.com");
      ws.binaryType = "arraybuffer";
      document.getElementById("status").textContent = "Connected. Buffering...";

      ws.onmessage = (event) => {
        const data = event.data.slice(0);
        audioQueue.push(data);

        if (!isPlaying && audioQueue.length >= MIN_BUFFER) {
          isPlaying = true;
          playNext();
        }
      };
    }

    function playNext() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        document.getElementById("status").textContent = "Buffer underrunâ€¦";
        return;
      }

      const chunk = audioQueue.shift();

      audioContext.decodeAudioData(chunk, (buffer) => {
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
        source.onended = playNext;
      }, (err) => {
        console.error("Decode error", err);
        playNext();
      });
    }
  </script>
</body>
</html>
