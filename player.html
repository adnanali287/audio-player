<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Audio Stream Player</title>
</head>
<body>
  <h3>Tap to Start Listening</h3>
  <button onclick="start()">Start Listening</button>
  <div id="status">Idle</div>

  <!-- Silent video for background playback -->
  <video id="keepAlive" playsinline muted autoplay loop style="display: none;">
    <source src="data:video/mp4;base64,AAAAHGZ0eXBtcDQyAAAAAG1wNDFtcDQyaXNvbThtcDQyaXNvbWF2YzEAAAAIZnJlZQ==" type="video/mp4">
  </video>

  <script>
    let ws;
    let audioContext;
    let audioQueue = [];
    let isPlaying = false;
    const MIN_BUFFER = 3;

    function start() {
      // Start silent video
      document.getElementById("keepAlive").play();

      // Start Web Audio
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      ws = new WebSocket("wss://audio-stream-backend-688e.onrender.com");
      ws.binaryType = "arraybuffer";
      document.getElementById("status").textContent = "Connected. Buffering...";

      ws.onmessage = (event) => {
        const data = event.data.slice(0);
        audioQueue.push(data);

        if (!isPlaying && audioQueue.length >= MIN_BUFFER) {
          isPlaying = true;
          playNext();
        }
      };
    }

    function playNext() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        document.getElementById("status").textContent = "Buffer underrunâ€¦";
        return;
      }

      const chunk = audioQueue.shift();

      audioContext.decodeAudioData(chunk, (buffer) => {
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
        source.onended = playNext;
      }, (err) => {
        console.error("Decode error", err);
        playNext();
      });
    }
  </script>
</body>
</html>
