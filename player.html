<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Audio Stream Player</title>
</head>
<body>
  <h3>Tap to Start Listening</h3>
  <button onclick="start()">Start Listening</button>

  <script>
    let ws;
    let audioContext;
    let audioQueue = [];

    function start() {
      audioContext = new AudioContext();
      ws = new WebSocket("wss://audio-stream-backend-688e.onrender.com");
      ws.binaryType = "arraybuffer";

      ws.onmessage = (event) => {
        const data = event.data.slice(0);
        audioQueue.push(data);
      };

      // Start playing with a 500ms buffer delay
      setTimeout(playNext, 500);
    }

    function playNext() {
      if (audioQueue.length === 0) {
        setTimeout(playNext, 100);
        return;
      }

      const chunk = audioQueue.shift();
      audioContext.decodeAudioData(chunk, (buffer) => {
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
        playNext(); // continue playing
      }, (err) => {
        console.error("Decode error", err);
        playNext(); // skip bad chunk
      });
    }
  </script>
</body>
</html>
