<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Audio Stream Player</title>
</head>
<body>
  <h3>Tap to Start Listening</h3>
  <button onclick="start()">Start Listening</button>
  <div id="status">Idle</div>

  <script>
    let ws;
    let audioContext;
    let audioQueue = [];
    let isPlaying = false;
    let MIN_BUFFER = 3; // Number of chunks to buffer before playing

    function start() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      ws = new WebSocket("wss://audio-stream-backend-688e.onrender.com");
      ws.binaryType = "arraybuffer";
      document.getElementById("status").textContent = "Connected. Buffering...";

      ws.onmessage = (event) => {
        const data = event.data.slice(0);
        audioQueue.push(data);

        if (!isPlaying && audioQueue.length >= MIN_BUFFER) {
          isPlaying = true;
          playNext(); // start playing
        }
      };
    }

    function playNext() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        document.getElementById("status").textContent = "Buffer underrunâ€¦";
        return;
      }

      const chunk = audioQueue.shift();

      audioContext.decodeAudioData(chunk, (buffer) => {
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
        source.onended = () => {
          playNext(); // move to next chunk after playback
        };
      }, (err) => {
        console.error("Decode error", err);
        playNext(); // skip bad chunk
      });
    }
  </script>
</body>
</html>
